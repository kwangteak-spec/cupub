from datetime import datetime, timedelta, date
import pandas as pd
import os

# ì§ì›ëª…ë¶€ ë¶ˆëŸ¬ì˜¤ê¸°

def load_ì§ì›ëª…ë¶€():
    file_path = r"c:\\python\\name.txt"
    if not os.path.exists(file_path):
        raise FileNotFoundError(f"ì§ì›ëª…ë¶€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {file_path}")
    ì§ì›ëª…ë¶€ = {}
    with open(file_path, encoding='utf-8') as f:
        next(f)
        for line in f:
            name, group, days = line.strip().split(',')
            íœ´ë¬´ìš”ì¼ = days.split('|') if days else []
            ì§ì›ëª…ë¶€[name] = {"ì¡°": group, "íœ´ë¬´ìš”ì¼": íœ´ë¬´ìš”ì¼}
    return ì§ì›ëª…ë¶€

# ê³µíœ´ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ë° ê¸°ì¤€ ê·¼ë¬´ì‹œê°„ ê³„ì‚°

def load_ê³µíœ´ì¼ëª©ë¡(ê²½ë¡œ=r"c:\\python\\holidays.txt"):
    if not os.path.exists(ê²½ë¡œ):
        with open(ê²½ë¡œ, "w", encoding="utf-8") as f:
            f.write("# YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ê³µíœ´ì¼ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n")
        print(f"âœ… ê³µíœ´ì¼ ì •ë³´ íŒŒì¼ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”: {ê²½ë¡œ}")
        return set()
    holidays = set()
    with open(ê²½ë¡œ, "r", encoding="utf-8") as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith("#"):
                try:
                    holidays.add(datetime.strptime(line, "%Y-%m-%d").date())
                except ValueError:
                    print(f"âš ï¸ ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜: {line} (ì˜¬ë°”ë¥¸ í˜•ì‹: YYYY-MM-DD)")
    return holidays

def get_ê¸°ì¤€ê·¼ë¬´ì‹œê°„(ì—°ë„=2025, ì›”=5):
    start_date = date(ì—°ë„, ì›”, 1)
    end_date = date(ì—°ë„, ì›”, 31)
    ê³µíœ´ì¼ëª©ë¡ = load_ê³µíœ´ì¼ëª©ë¡()
    ê·¼ë¬´ì¼ìˆ˜ = 0
    current = start_date
    while current <= end_date:
        if current.weekday() < 5 and current not in ê³µíœ´ì¼ëª©ë¡:
            ê·¼ë¬´ì¼ìˆ˜ += 1
        current += timedelta(days=1)
    ê¸°ì¤€ì‹œê°„ = ê·¼ë¬´ì¼ìˆ˜ * 8
    return ê·¼ë¬´ì¼ìˆ˜, ê¸°ì¤€ì‹œê°„

# ê·¼ë¬´ì‹œê°„ ê³„ì‚°

def ê³„ì‚°_ê·¼ë¬´ì‹œê°„(ê·¼ë¬´ê¸°ë¡):
    return ê·¼ë¬´ê¸°ë¡["ì˜¤ì „"] * 8 + ê·¼ë¬´ê¸°ë¡["ì˜¤í›„"] * 8 + ê·¼ë¬´ê¸°ë¡["ì•¼ê°„"] * 12

# ì¶”ì²œ íœ´ë¬´ì¼ ê³„ì‚°

def ì¶”ì²œ_íœ´ë¬´ì¼(ê¸°ì¡´_íœ´ë¬´ìš”ì¼):
    ìš”ì¼ìˆœì„œ = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"]
    if not ê¸°ì¡´_íœ´ë¬´ìš”ì¼:
        return None
    ì²«ì§¸ = ê¸°ì¡´_íœ´ë¬´ìš”ì¼[0]
    idx = ìš”ì¼ìˆœì„œ.index(ì²«ì§¸)
    ì¶”ì²œìš”ì¼ = ìš”ì¼ìˆœì„œ[idx - 1]
    return ì¶”ì²œìš”ì¼

# ì´ˆê³¼ê·¼ë¬´ ìë™ ì¡°ì •

def apply_auto_rest(df, ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜, ì¶œê·¼ê¸°ë¡, ì§ì›ëª…ë¶€):
    print("\n=== âš ï¸ ì´ˆê³¼ ê·¼ë¬´ì ì¡°ì • ë° ìë™ íœ´ë¬´ì¼ ì§€ì • ===")
    ê¸°ì¤€ê·¼ë¬´ì‹œê°„ = get_ê¸°ì¤€ê·¼ë¬´ì‹œê°„()[1]
    ì´ˆê³¼ì_ë¦¬ìŠ¤íŠ¸ = []
    for ì´ë¦„, ê¸°ë¡ in ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜.items():
        ì´ì‹œê°„ = ê³„ì‚°_ê·¼ë¬´ì‹œê°„(ê¸°ë¡)
        if ì´ì‹œê°„ > ê¸°ì¤€ê·¼ë¬´ì‹œê°„:
            ì´ˆê³¼ì‹œê°„ = ì´ì‹œê°„ - ê¸°ì¤€ê·¼ë¬´ì‹œê°„
            ì œê±°_ì¼ìˆ˜ = 0
            for ë‚ ì§œ, ìƒíƒœ in ì¶œê·¼ê¸°ë¡[ì´ë¦„].items():
                if ì´ˆê³¼ì‹œê°„ < 12: break
                if ìƒíƒœ == "ê·¼ë¬´" and df[df['ì¼ì'].str.contains(f"{int(ë‚ ì§œ[-2:])}ì¼")]["ì•¼ê°„"].str.contains(ì´ë¦„).any():
                    ì¶œê·¼ê¸°ë¡[ì´ë¦„][ë‚ ì§œ] = "íœ´ë¬´"
                    ê¸°ë¡["ì•¼ê°„"] -= 1
                    ì´ˆê³¼ì‹œê°„ -= 12
                    ì œê±°_ì¼ìˆ˜ += 1
            for shift in ["ì˜¤ì „", "ì˜¤í›„"]:
                for ë‚ ì§œ, ìƒíƒœ in ì¶œê·¼ê¸°ë¡[ì´ë¦„].items():
                    if ì´ˆê³¼ì‹œê°„ < 8: break
                    if ìƒíƒœ == "ê·¼ë¬´" and df[df['ì¼ì'].str.contains(f"{int(ë‚ ì§œ[-2:])}ì¼")][shift].str.contains(ì´ë¦„).any():
                        ì¶œê·¼ê¸°ë¡[ì´ë¦„][ë‚ ì§œ] = "íœ´ë¬´"
                        ê¸°ë¡[shift] -= 1
                        ì´ˆê³¼ì‹œê°„ -= 8
                        ì œê±°_ì¼ìˆ˜ += 1
            ì¶”ì²œ = ì¶”ì²œ_íœ´ë¬´ì¼(ì§ì›ëª…ë¶€[ì´ë¦„]["íœ´ë¬´ìš”ì¼"])
            ì´ˆê³¼ì_ë¦¬ìŠ¤íŠ¸.append({
                "ì´ë¦„": ì´ë¦„,
                "ì´ˆê³¼ì‹œê°„": ì´ì‹œê°„ - ê¸°ì¤€ê·¼ë¬´ì‹œê°„,
                "ì œê±°_ì¼ìˆ˜": ì œê±°_ì¼ìˆ˜,
                "ì¶”ì²œíœ´ë¬´ìš”ì¼": ì¶”ì²œ
            })
    return pd.DataFrame(ì´ˆê³¼ì_ë¦¬ìŠ¤íŠ¸)
def create_schedule():
    ì§ì›ëª…ë¶€ = load_ì§ì›ëª…ë¶€()
    start_date = datetime(2025, 5, 1)
    end_date = datetime(2025, 5, 31)
    weekday_kor = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"]

    ì˜¤í›„ì¡°_ì•¼ê°„ì§€ì›ì¼ = {
        "2025-05-05": "ê¹€ì œì›",
        "2025-05-09": "ì¥ì˜ëŒ€",
        "2025-05-16": "ì¥ì˜ëŒ€",
        "2025-05-19": "ê¹€ì œì›",
        "2025-05-26": "ê¹€ì œì›"
    }

    ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜ = {name: {"ì˜¤ì „": 0, "ì˜¤í›„": 0, "ì•¼ê°„": 0} for name in ì§ì›ëª…ë¶€}
    ì¶œê·¼ê¸°ë¡ = {name: {} for name in ì§ì›ëª…ë¶€}
    ìˆœë²ˆ = {"ì˜¤ì „ì¡°": 0, "ì˜¤í›„ì¡°": 0}
    ì•¼ê°„ì¡°_ìˆœì„œ = [name for name, info in ì§ì›ëª…ë¶€.items() if info["ì¡°"] == "ì•¼ê°„ì¡°"]
    ê·¼ë¬´í‘œ = []

    for i in range((end_date - start_date).days + 1):
        date = start_date + timedelta(days=i)
        date_str = date.strftime("%Y-%m-%d")
        for name in ì¶œê·¼ê¸°ë¡:
            ì¶œê·¼ê¸°ë¡[name][date_str] = "íœ´ë¬´"

    ì•¼ê°„_ë‚ ì§œë¦¬ìŠ¤íŠ¸ = [start_date + timedelta(days=i) for i in range((end_date - start_date).days + 1)
                   if (start_date + timedelta(days=i)).strftime("%Y-%m-%d") not in ì˜¤í›„ì¡°_ì•¼ê°„ì§€ì›ì¼]

    ì•¼ê°„_ì¼ì •í‘œ = {}
    for i, day in enumerate(ì•¼ê°„_ë‚ ì§œë¦¬ìŠ¤íŠ¸):
        ë‹´ë‹¹ì = ì•¼ê°„ì¡°_ìˆœì„œ[(i // 2) % 2]
        if i == len(ì•¼ê°„_ë‚ ì§œë¦¬ìŠ¤íŠ¸) - 1 and len(ì•¼ê°„_ë‚ ì§œë¦¬ìŠ¤íŠ¸) % 2 != 0:
            ë‹´ë‹¹ì = ì•¼ê°„ì¡°_ìˆœì„œ[1]
        date_str = day.strftime("%Y-%m-%d")
        ì•¼ê°„_ì¼ì •í‘œ[date_str] = ë‹´ë‹¹ì

    for i in range((end_date - start_date).days + 1):
        current = start_date + timedelta(days=i)
        ìš”ì¼ = weekday_kor[current.weekday()]
        ì¼ì = current.day
        date_str = current.strftime("%Y-%m-%d")
        ì˜¤í›„ì•¼ê°„ì§€ì›ì = ì˜¤í›„ì¡°_ì•¼ê°„ì§€ì›ì¼.get(date_str)

        ì˜¤ì „ = []
        ì˜¤í›„ = []
        ì•¼ê°„ = ""

        ì˜¤ì „í›„ë³´ = [name for name, info in ì§ì›ëª…ë¶€.items() if info["ì¡°"] == "ì˜¤ì „ì¡°" and ìš”ì¼ not in info["íœ´ë¬´ìš”ì¼"]]
        for _ in range(2):
            if ì˜¤ì „í›„ë³´:
                ì´ë¦„ = ì˜¤ì „í›„ë³´[ìˆœë²ˆ["ì˜¤ì „ì¡°"] % len(ì˜¤ì „í›„ë³´)]
                if ì´ë¦„ not in ì˜¤ì „:
                    ì˜¤ì „.append(ì´ë¦„)
                    ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜[ì´ë¦„]["ì˜¤ì „"] += 1
                    ì¶œê·¼ê¸°ë¡[ì´ë¦„][date_str] = "ê·¼ë¬´"
                    ìˆœë²ˆ["ì˜¤ì „ì¡°"] += 1

        ì˜¤í›„í›„ë³´ = [name for name, info in ì§ì›ëª…ë¶€.items() if info["ì¡°"] == "ì˜¤í›„ì¡°" and ìš”ì¼ not in info["íœ´ë¬´ìš”ì¼"] and name != ì˜¤í›„ì•¼ê°„ì§€ì›ì]
        for _ in range(3):
            if ì˜¤í›„í›„ë³´:
                ì´ë¦„ = ì˜¤í›„í›„ë³´[ìˆœë²ˆ["ì˜¤í›„ì¡°"] % len(ì˜¤í›„í›„ë³´)]
                if ì´ë¦„ not in ì˜¤í›„:
                    ì˜¤í›„.append(ì´ë¦„)
                    ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜[ì´ë¦„]["ì˜¤í›„"] += 1
                    ì¶œê·¼ê¸°ë¡[ì´ë¦„][date_str] = "ê·¼ë¬´"
                    ìˆœë²ˆ["ì˜¤í›„ì¡°"] += 1

        if ì˜¤í›„ì•¼ê°„ì§€ì›ì:
            ì•¼ê°„ = f"{ì˜¤í›„ì•¼ê°„ì§€ì›ì}(ì˜¤í›„ê·¼ë¬´)"
            ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜[ì˜¤í›„ì•¼ê°„ì§€ì›ì]["ì•¼ê°„"] += 1
            ì¶œê·¼ê¸°ë¡[ì˜¤í›„ì•¼ê°„ì§€ì›ì][date_str] = "ê·¼ë¬´"
        else:
            ë‹´ë‹¹ì = ì•¼ê°„_ì¼ì •í‘œ[date_str]
            ì•¼ê°„ = ë‹´ë‹¹ì
            ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜[ë‹´ë‹¹ì]["ì•¼ê°„"] += 1
            ì¶œê·¼ê¸°ë¡[ë‹´ë‹¹ì][date_str] = "ê·¼ë¬´"

        ê·¼ë¬´í‘œ.append({
            "ì¼ì": f"{ì¼ì}ì¼({ìš”ì¼})",
            "ì˜¤ì „": " ".join(ì˜¤ì „),
            "ì˜¤í›„": " ".join(ì˜¤í›„),
            "ì•¼ê°„": ì•¼ê°„
        })

    return pd.DataFrame(ê·¼ë¬´í‘œ), ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜, ì§ì›ëª…ë¶€, ì¶œê·¼ê¸°ë¡
 #ì¶”ì²œ íœ´ë¬´ ìš”ì¼ì— í•´ë‹¹í•˜ëŠ” 5ì›” ë‚ ì§œ ëª©ë¡ ìƒì„±
def ì¶”ì²œíœ´ë¬´ì¼_ë‚ ì§œëª©ë¡(ì¶”ì²œê²°ê³¼):
    ë‚ ì§œëª¨ìŒ = []
    for _, row in ì¶”ì²œê²°ê³¼.iterrows():
        ì´ë¦„ = row["ì´ë¦„"]
        ì¶”ì²œìš”ì¼ = row["ì¶”ì²œíœ´ë¬´ìš”ì¼"]
        if ì¶”ì²œìš”ì¼ is None:
            continue
        ë‚ ì§œë“¤ = []
        for i in range(31):
            d = datetime(2025, 5, i + 1)
            if d.strftime("%a") in ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]:
                if d.strftime("%a") == ì¶”ì²œìš”ì¼:
                    ë‚ ì§œë“¤.append(d.strftime("%Y-%m-%d"))
                else:
                    weekday_kor = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"]
                    if weekday_kor[d.weekday()] == ì¶”ì²œìš”ì¼:
                        ë‚ ì§œë“¤.append(d.strftime("%Y-%m-%d"))
        ë‚ ì§œëª¨ìŒ.append({
            "ì´ë¦„": ì´ë¦„,
            "ì¶”ì²œíœ´ë¬´ìš”ì¼": ì¶”ì²œìš”ì¼,
            "í•´ë‹¹ë‚ ì§œë“¤": ", ".join(ë‚ ì§œë“¤)
        })
    return pd.DataFrame(ë‚ ì§œëª¨ìŒ)


# ì‹¤í–‰
if __name__ == "__main__":
    df, ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜, ì§ì›ëª…ë¶€, ì¶œê·¼ê¸°ë¡ = create_schedule()

    print("=== ğŸ“… 5ì›” ê·¼ë¬´í‘œ ===")
    print(df.to_string(index=False))

    print("\n=== ğŸ“Š ê°œì¸ë³„ ê·¼ë¬´ì¼ìˆ˜ ë° ê·¼ë¬´ì‹œê°„ ===")
    í†µê³„í‘œ = []
    for ì´ë¦„, ê¸°ë¡ in ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜.items():
        ì´ì‹œê°„ = ê³„ì‚°_ê·¼ë¬´ì‹œê°„(ê¸°ë¡)
        print(f"{ì´ë¦„}: ì˜¤ì „ {ê¸°ë¡['ì˜¤ì „']}ì¼, ì˜¤í›„ {ê¸°ë¡['ì˜¤í›„']}ì¼, ì•¼ê°„ {ê¸°ë¡['ì•¼ê°„']}ì¼ â†’ ì´ {ì´ì‹œê°„}ì‹œê°„")
        í†µê³„í‘œ.append({
            "ì´ë¦„": ì´ë¦„,
            "ì˜¤ì „ ê·¼ë¬´ì¼ìˆ˜": ê¸°ë¡["ì˜¤ì „"],
            "ì˜¤í›„ ê·¼ë¬´ì¼ìˆ˜": ê¸°ë¡["ì˜¤í›„"],
            "ì•¼ê°„ ê·¼ë¬´ì¼ìˆ˜": ê¸°ë¡["ì•¼ê°„"],
            "ì´ ê·¼ë¬´ì‹œê°„": ì´ì‹œê°„
        })

    í†µê³„_df = pd.DataFrame(í†µê³„í‘œ)
    ì¶œê·¼í‘œ = pd.DataFrame(ì¶œê·¼ê¸°ë¡).T
    ì¶œê·¼í‘œ.index.name = "ì´ë¦„"

    print("\n=== ğŸ“Œ ê°œì¸ë³„ ë‚ ì§œë³„ ì¶œê·¼í‘œ (ê·¼ë¬´/íœ´ë¬´) ===")
    print(ì¶œê·¼í‘œ.to_string())

    # ì´ˆê³¼ê·¼ë¬´ì ìë™ ì¡°ì •
    ì¡°ì •ê²°ê³¼ = apply_auto_rest(df, ê°œì¸ë³„_ê·¼ë¬´ì¼ìˆ˜, ì¶œê·¼ê¸°ë¡, ì§ì›ëª…ë¶€)
    print("\n=== ğŸ›  ì¡°ì • ê²°ê³¼ ===")
    print(ì¡°ì •ê²°ê³¼.to_string(index=False))

    # ì €ì¥
    output_path = r"c:\\python\\ê·¼ë¬´í‘œ_2025_05.xlsx"
    with pd.ExcelWriter(output_path, engine='openpyxl', mode='w') as writer:
        df.to_excel(writer, sheet_name='5ì›” ê·¼ë¬´í‘œ', index=False)
        í†µê³„_df.to_excel(writer, sheet_name='ê°œì¸ë³„ í†µê³„', index=False)
        ì¶œê·¼í‘œ.to_excel(writer, sheet_name='ì¶œê·¼í‘œ', index=True)
        ì¡°ì •ê²°ê³¼.to_excel(writer, sheet_name='ì´ˆê³¼ê·¼ë¬´ì¡°ì •', index=False)
        ì¶”ì²œë‚ ì§œí‘œ = ì¶”ì²œíœ´ë¬´ì¼_ë‚ ì§œëª©ë¡(ì¡°ì •ê²°ê³¼)
        ì¶”ì²œë‚ ì§œí‘œ.to_excel(writer, sheet_name='ì¶”ì²œíœ´ë¬´ì¼', index=False)

    print(f"\nâœ… ì—‘ì…€ íŒŒì¼ ì €ì¥ ì™„ë£Œ: {output_path}")


# create_schedule ë° ì¶”ì²œíœ´ë¬´ì¼_ë‚ ì§œëª©ë¡ í•¨ìˆ˜ëŠ” ê¸°ì¡´ëŒ€ë¡œ ì•„ë˜ì— ì¶”ê°€í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
# ì‹¤í–‰ë¶€ (if __name__ == '__main__') ì•ˆì—ì„œ ê¸°ì¤€ê·¼ë¬´ì‹œê°„ ê³„ì‚°, ê·¼ë¬´í‘œ ìƒì„±, ì´ˆê³¼ê·¼ë¬´ íŒë‹¨, ì—‘ì…€ ì €ì¥ í¬í•¨í•˜ì—¬ ì™„ì„±í•˜ì„¸ìš”.
